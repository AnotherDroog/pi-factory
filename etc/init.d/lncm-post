#!/sbin/openrc-run

## LNCM post-installation script
## To be run on persistently installed SD card

depend() {
    need net sshd lncm-online ntpd
}

start() {
  ebegin "Starting LNCM post-installation"
  # This script will only run once, to complete post-installation

  if [ -f /media/mmcblk0p1/installed ]; then
    echo "Let apk cache live on persistent volume"
    if [ -d /media/mmcblk0p1/cache ]; then
      cp -v /media/mmcblk0p1/cache/* /var/cache/apk/
    fi
    /sbin/setup-apkcache /var/cache/apk

    echo "Install docker-compose and dependencies for config files"
    # Install dependencies for docker compose, for generating config files, and to assist with querying containers
    /sbin/apk update && \
    /sbin/apk add python3 curl jq

    /usr/bin/pip3 install --upgrade pip && \
    /usr/bin/pip3 install docker-compose

    # USB storage setup
    /usr/bin/python3 /usr/local/sbin/lncm-usb.py || exit 1

    # Verify USB setup succeeded
    if [ ! -d /media/archive ]; then
      echo 'USB setup failed'
      exit 1
    elif [ ! -d /media/important ]; then
      echo 'USB setup failed'
      exit 1
    elif [ ! -d /media/volatile ]; then
      echo 'USB setup failed'
      exit 1
    fi

    # Generate RPC auth
    echo "Generate RPC auth from bitcoin repo"
    curl "https://raw.githubusercontent.com/bitcoin/bitcoin/master/share/rpcauth/rpcauth.py" 2>/dev/null 1>rpcauth.py
    if [ -f ./rpcauth.py ]; then
      chmod 700 rpcauth.py
      ./rpcauth.py lncm | tee /media/important/generated.txt | head -2 | tail -1 > /media/important/rpcauth.txt
      cat /media/important/generated.txt | tail -1 > /media/important/rpcpass.txt
      rm rpcauth.py /media/important/generated.txt
    else
      echo "rpcauth not generated - could not reach server"
      exit 1
    fi

    if [ $(grep -c rpcauth /media/important/rpcauth.txt ) == 0 ]; then
      echo "Can't generate credentials - exiting!"
      exit 1
    fi

    # Apply RPC auth
    if [ -f /media/important/rpcauth.txt ]; then
      # Replace strings with what was generated
      RPCAUTHLINE=`cat /media/important/rpcauth.txt`
      GENERATEDPW=`cat /media/important/rpcpass.txt`
      /bin/sed -i "s/GENERATEDRPCAUTH/$RPCAUTHLINE/g;"  /home/lncm/bitcoin/bitcoin.conf
      /bin/sed -i "s/GENERATEDRPCAUTH/$RPCAUTHLINE/g;"  /home/lncm/litecoin/litecoin.conf
      /bin/sed -i "s/RANDOMUSER/lncm/g;"  /home/lncm/lnd/lnd.conf
      /bin/sed -i "s/RANDOMPASS/$GENERATEDPW/g;"  /home/lncm/lnd/lnd.conf
      /bin/sed -i "s/RANDOMUSER/lncm/g;"  /home/lncm/lightning/config
      /bin/sed -i "s/RANDOMPASS/$GENERATEDPW/g;"  /home/lncm/lightning/config
      /bin/sed -i "s/RANDOMUSER/lncm/g;"  /home/lncm/compose/docker-compose.yml
      /bin/sed -i "s/RANDOMPASS/$GENERATEDPW/g;"  /home/lncm/compose/docker-compose.yml
    else
      echo "Error generating config files"
      exit 1
    fi

    # Install Tor
    echo "Installing and starting TOR (and waiting about 10 seconds)"
    /sbin/apk update && /sbin/apk add tor
    /sbin/service tor start
    # Add tor to default runlevels
    /sbin/rc-update add tor default

    CHECKTOR_HOSTNAME=1
    # Check to see if Tor generated directory exists
    while [ ! -d /var/lib/tor/lightning ] && [ $CHECKTOR_HOSTNAME -lt 10 ];
    do
      echo "Tor generated directory doesn't exist yet.. waiting";
      let CHECKTOR_HOSTNAME=CHECKTOR_HOSTNAME+1;
      sleep 1;
    done

    # Now check to see if hostname exists
    if [ -f /var/lib/tor/lightning/hostname ]; then
      echo "Configuring lnd to have tor as a URI available"
      /bin/sed -i "s/; externalip=/externalip=$(cat /var/lib/tor/lightning/hostname)/g; " /home/lncm/lnd/lnd.conf
    else
      echo "Could not find the tor generated files.. exiting"
      exit 1
    fi
    # Check if theres a V2 hostname, but don't exit uncleanly, just let it go
    if [ -f /var/lib/tor/lightning-tor-v2/hostname ]; then
        echo "Configuring a V2 URI"
        /bin/sed -i "s/; 2 externalip=/externalip=$(cat /var/lib/tor/lightning-tor-v2/hostname)/g; " /home/lncm/lnd/lnd.conf
    fi

    echo "Checking for existing configs"
    if [ -f /media/important/bitcoin/bitcoin.conf ]; then
      echo "bitcoin.conf exists, making backup and replacing"
      /bin/cp /media/important/bitcoin/bitcoin.conf /media/important/bitcoin/bitcoin.conf.backup &&
      /bin/cp -f /home/lncm/bitcoin/bitcoin.conf /media/important/bitcoin/bitcoin.conf
    else
      # If not exist copy bitcoin.conf from lncm home directory
      /bin/cp -f /home/lncm/bitcoin/bitcoin.conf /media/important/bitcoin/bitcoin.conf
    fi

    if [ -f /media/important/lnd/lnd.conf ]; then
      echo "lnd.conf exists, making backup and replacing"
      /bin/cp /media/important/lnd/lnd.conf /media/important/lnd/lnd.conf.backup &&
      /bin/cp -f /home/lncm/lnd/lnd.conf /media/important/lnd/lnd.conf
    else
      # If not exist copy lnd.conf from home directory
      /bin/cp -f /home/lncm/lnd/lnd.conf /media/important/lnd/lnd.conf
    fi

    # nginx configs
    if [ -f /media/important/nginx/nginx.conf ]; then
        echo "nginx.conf exists, making backup and replacing"
        /bin/cp /media/important/nginx/nginx.conf /media/important/nginx/nginx.conf.backup &&
        /bin/cp -f /home/lncm/nginx/nginx.conf /media/important/nginx/nginx.conf
    else
        /bin/cp -f /home/lncm/nginx/nginx.conf /media/important/nginx/nginx.conf
    fi
    if [ -f /media/important/nginx/conf.d/default.conf ]; then
        echo "default.conf exists, making backup and replacing"
        /bin/cp /media/important/nginx/conf.d/default.conf /media/important/nginx/conf.d/default.conf.backup &&
        /bin/cp -f /home/lncm/nginx/conf.d/default.conf /media/important/nginx/conf.d/default.conf
    else
        /bin/cp -f /home/lncm/nginx/conf.d/default.conf /media/important/nginx/conf.d/default.conf
    fi
    if [ -f /media/important/nginx/mime.types ]; then
        echo "mime.types exists, making backup and replacing"
        /bin/cp /media/important/nginx/mime.types /media/important/nginx/mime.types.backup &&
        /bin/cp -f /home/lncm/nginx/mime.types /media/important/nginx/mime.types
    else
        /bin/cp -f /home/lncm/nginx/mime.types /media/important/nginx/mime.types
    fi

    echo "Install crontab"
    /usr/bin/crontab /home/lncm/crontab

    # Backup apkovl.tar.gz to USB storage
    /sbin/lbu pkg /media/important

    echo "Remove lncm-post from boot"
    /sbin/rc-update del lncm-post default

    echo "Enable docker-compose at boot"
    /sbin/rc-update add docker-compose default
    /sbin/service docker-compose start

    exit 0
  else
    echo "LNCM persistent installation not found!"
    exit 1
  fi

  eend $?
}
